<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>/N/e/w/s/ BBS</title>
    <style>
        /* 1. 폰트: 둥근모 */
        @font-face {
            font-family: 'DungGeunMo';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff') format('woff');
            font-weight: normal;
            font-display: swap;
        }

        /* 2. 테마 변수 */
        :root {
            --bg-color: #000000;    /* 터미널 블랙 */
            --text-main: #A8A8A8;   /* 기본 회색 */
            --text-high: #FFFFFF;   /* 강조 흰색 */
            --text-yellow: #FFFF55; /* 노란색 */
            --text-cyan: #55FFFF;   /* 하늘색 */
            --text-green: #55FF55;  /* 초록색 */
            --text-red: #FF5555;    /* 빨간색 */
            --dim-black: #000000;
        }

        /* 기본 설정 - 전체화면 */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            font-family: 'DungGeunMo', monospace;
            overflow: hidden;
            color: var(--text-main);
        }

        /* 모니터 컨테이너 */
        #monitor {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
        }

        /* 실제 화면 영역 */
        #screen {
            flex: 1;
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: none;
            box-shadow: none;
            max-width: none;
            max-height: none;
        }

        /* 상단 상태바 */
        #status-bar {
            background-color: var(--text-main);
            color: var(--bg-color);
            padding: 4px 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            flex-shrink: 0;
        }

        /* 메인 컨텐츠 영역 */
        #main-view {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 18px;
            line-height: 1.6;
            white-space: pre-wrap;
            scrollbar-width: none;
        }
        #main-view::-webkit-scrollbar { display: none; }

        /* 하단 명령 입력줄 */
        #command-line {
            background-color: var(--bg-color);
            border-top: 2px solid var(--bg-color); 
            padding: 10px 15px;
            font-size: 18px;
            color: var(--text-yellow);
            display: flex;
            align-items: center;
            min-height: 50px;
            flex-shrink: 0;
        }
        
        #cmd-input {
            background: transparent;
            border: none;
            color: var(--text-high);
            font-family: 'DungGeunMo', monospace;
            font-size: 18px;
            outline: none;
            flex: 1;
            margin-left: 10px;
            text-transform: uppercase;
        }

        /* 깜빡이는 커서 */
        .cursor {
            display: inline-block;
            width: 10px;
            height: 18px;
            background-color: var(--text-high);
            animation: blink 1s step-end infinite;
            vertical-align: middle;
            margin-left: 2px;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* 유틸리티 클래스 */
        .c-w { color: var(--text-high); }
        .c-y { color: var(--text-yellow); }
        .c-c { color: var(--text-cyan); }
        .c-g { color: var(--text-green); }
        .c-r { color: var(--text-red); }
        
        /* 링크/버튼 스타일 */
        .t-link {
            cursor: pointer;
            color: var(--text-high);
            text-decoration: none;
            padding: 2px 0;
            display: block; 
        }
        .t-link:hover, .t-link:active {
            color: var(--text-yellow);
            background-color: #000080;
        }
    </style>
</head>
<body>

<div id="monitor">
    <div id="screen">
        <!-- 상단 상태바 -->
        <div id="status-bar">
            <span>/N/e/w/s/ BBS</span>
            <span id="clock">00:00:00</span>
            <span>Online</span>
        </div>

        <!-- 메인 뷰 -->
        <div id="main-view">
            <!-- 콘텐츠 로드 -->
        </div>

        <!-- 하단 명령줄 -->
        <div id="command-line">
            <span id="prompt-text">선택(번호) ></span>
            <input type="text" id="cmd-input" maxlength="10" autocomplete="off">
            <span class="cursor"></span>
        </div>
    </div>
</div>

<script>
    // --- 설정 및 상태 ---
    let currentPage = 100;
    let inputBlocked = false;
    
    // 프록시 설정
    const PROXIES = [
        "https://corsproxy.io/?",
        "https://api.allorigins.win/raw?url="
    ];

    // 뉴스 카테고리
    const NEWS_CATS = {
        // [뉴시스] 10번대
        11: { t: "뉴시스 속보", u: "https://www.newsis.com/RSS/sokbo.xml" },
        12: { t: "뉴시스 정치", u: "https://www.newsis.com/RSS/politics.xml" },
        13: { t: "뉴시스 경제", u: "https://www.newsis.com/RSS/economy.xml" },
        14: { t: "뉴시스 금융", u: "https://www.newsis.com/RSS/bank.xml" },
        15: { t: "뉴시스 산업", u: "https://www.newsis.com/RSS/industry.xml" },
        16: { t: "뉴시스 사회", u: "https://www.newsis.com/RSS/society.xml" },
        17: { t: "뉴시스 국제", u: "https://www.newsis.com/RSS/international.xml" },
        18: { t: "뉴시스 문화", u: "https://www.newsis.com/RSS/culture.xml" },
        19: { t: "뉴시스 스포츠", u: "https://www.newsis.com/RSS/sports.xml" },
        
        // [연합뉴스] 20번대
        21: { t: "연합 전체기사", u: "https://www.yna.co.kr/rss/news.xml" },
        22: { t: "연합 정치", u: "https://www.yna.co.kr/rss/politics.xml" },
        23: { t: "연합 경제", u: "https://www.yna.co.kr/rss/economy.xml" },
        24: { t: "연합 산업", u: "https://www.yna.co.kr/rss/industry.xml" },
        25: { t: "연합 사회", u: "https://www.yna.co.kr/rss/society.xml" },
        26: { t: "연합 전국", u: "https://www.yna.co.kr/rss/local.xml" },
        27: { t: "연합 국제", u: "https://www.yna.co.kr/rss/international.xml" },
        28: { t: "연합 문화", u: "https://www.yna.co.kr/rss/culture.xml" },
        29: { t: "연합 스포츠", u: "https://www.yna.co.kr/rss/sports.xml" }
    };

    // [전국 상세 시/군/구 좌표 데이터] - 김천 포함 80여곳
    // Open-Meteo는 좌표 기반이므로 이름과 좌표 매핑이 중요
    const KOREA_CITIES = {
        // 수도권 (서울/인천/경기) - 32
        "서울": {la:37.57, lo:126.97, reg: 32}, "인천": {la:37.48, lo:126.62, reg: 32}, "수원": {la:37.26, lo:126.98, reg: 32},
        "파주": {la:37.88, lo:126.78, reg: 32}, "동두천": {la:37.90, lo:127.06, reg: 32}, "이천": {la:37.28, lo:127.44, reg: 32},
        "백령도": {la:37.97, lo:124.63, reg: 32}, "강화": {la:37.75, lo:126.48, reg: 32}, "양평": {la:37.49, lo:127.49, reg: 32},
        "성남": {la:37.44, lo:127.14, reg: 32}, "의정부": {la:37.74, lo:127.03, reg: 32}, "평택": {la:37.00, lo:127.11, reg: 32},
        
        // 강원도 - 33
        "춘천": {la:37.90, lo:127.74, reg: 33}, "강릉": {la:37.75, lo:128.89, reg: 33}, "속초": {la:38.21, lo:128.56, reg: 33},
        "철원": {la:38.15, lo:127.30, reg: 33}, "대관령": {la:37.68, lo:128.76, reg: 33}, "원주": {la:37.34, lo:127.95, reg: 33},
        "영월": {la:37.18, lo:128.46, reg: 33}, "태백": {la:37.17, lo:128.99, reg: 33}, "인제": {la:38.06, lo:128.17, reg: 33},
        "홍천": {la:37.68, lo:127.88, reg: 33}, "동해": {la:37.52, lo:129.11, reg: 33}, "정선": {la:37.38, lo:128.66, reg: 33},
        
        // 충청권 (대전/세종/충남/충북) - 34
        "대전": {la:36.37, lo:127.37, reg: 34}, "세종": {la:36.48, lo:127.29, reg: 34}, "청주": {la:36.64, lo:127.44, reg: 34},
        "충주": {la:36.97, lo:127.95, reg: 34}, "추풍령": {la:36.22, lo:127.99, reg: 34}, "서산": {la:36.77, lo:126.49, reg: 34},
        "천안": {la:36.81, lo:127.11, reg: 34}, "보령": {la:36.33, lo:126.56, reg: 34}, "부여": {la:36.27, lo:126.91, reg: 34},
        "금산": {la:36.11, lo:127.48, reg: 34}, "홍성": {la:36.60, lo:126.66, reg: 34}, "제천": {la:37.13, lo:128.19, reg: 34},
        "보은": {la:36.49, lo:127.73, reg: 34}, "공주": {la:36.45, lo:127.12, reg: 34}, "논산": {la:36.20, lo:127.09, reg: 34},

        // 전라권 (광주/전남/전북) - 35
        "광주": {la:35.17, lo:126.85, reg: 35}, "전주": {la:35.84, lo:127.13, reg: 35}, "목포": {la:34.81, lo:126.39, reg: 35},
        "여수": {la:34.76, lo:127.66, reg: 35}, "군산": {la:35.99, lo:126.72, reg: 35}, "완도": {la:34.31, lo:126.71, reg: 35},
        "고창": {la:35.43, lo:126.69, reg: 35}, "순천": {la:35.03, lo:127.38, reg: 35}, "진도": {la:34.47, lo:126.26, reg: 35},
        "흑산도": {la:34.68, lo:125.43, reg: 35}, "정읍": {la:35.56, lo:126.85, reg: 35}, "남원": {la:35.42, lo:127.39, reg: 35},
        "임실": {la:35.61, lo:127.28, reg: 35}, "장흥": {la:34.68, lo:126.92, reg: 35}, "해남": {la:34.55, lo:126.57, reg: 35},
        "고흥": {la:34.61, lo:127.28, reg: 35}, "나주": {la:35.01, lo:126.71, reg: 35}, "광양": {la:34.94, lo:127.70, reg: 35},

        // 경상권 (부산/대구/울산/경남/경북) - 36
        "부산": {la:35.10, lo:129.03, reg: 36}, "대구": {la:35.88, lo:128.62, reg: 36}, "울산": {la:35.56, lo:129.31, reg: 36},
        "창원": {la:35.23, lo:128.68, reg: 36}, "안동": {la:36.56, lo:128.72, reg: 36}, "포항": {la:36.03, lo:129.38, reg: 36},
        "상주": {la:36.41, lo:128.16, reg: 36}, "진주": {la:35.19, lo:128.08, reg: 36}, "거창": {la:35.67, lo:127.91, reg: 36},
        "통영": {la:34.85, lo:128.43, reg: 36}, "울릉도": {la:37.48, lo:130.91, reg: 36}, "김해": {la:35.22, lo:128.89, reg: 36},
        "경주": {la:35.83, lo:129.20, reg: 36}, "영천": {la:35.97, lo:128.94, reg: 36}, "영덕": {la:36.40, lo:129.36, reg: 36},
        "의성": {la:36.35, lo:128.69, reg: 36}, "봉화": {la:36.89, lo:128.73, reg: 36}, "영주": {la:36.87, lo:128.51, reg: 36},
        "문경": {la:36.62, lo:128.14, reg: 36}, "합천": {la:35.57, lo:128.17, reg: 36}, "밀양": {la:35.49, lo:128.74, reg: 36},
        "산청": {la:35.41, lo:127.87, reg: 36}, "남해": {la:34.82, lo:127.92, reg: 36}, "거제": {la:34.88, lo:128.62, reg: 36},
        "청송": {la:36.43, lo:129.05, reg: 36}, "김천": {la:36.14, lo:128.11, reg: 36}, "구미": {la:36.11, lo:128.33, reg: 36},
        "독도": {la:37.24, lo:131.86, reg: 36},

        // 제주권 - 37
        "제주": {la:33.51, lo:126.52, reg: 37}, "서귀포": {la:33.25, lo:126.56, reg: 37}, "성산": {la:33.39, lo:126.88, reg: 37},
        "고산": {la:33.29, lo:126.16, reg: 37}
    };

    // DOM 요소
    const mainView = document.getElementById('main-view');
    const cmdInput = document.getElementById('cmd-input');
    const clockSpan = document.getElementById('clock');
    const promptText = document.getElementById('prompt-text');

    // --- 시계 ---
    function updateClock() {
        const now = new Date();
        clockSpan.innerText = now.toLocaleTimeString('ko-KR', { hour12: false });
    }
    setInterval(updateClock, 1000);
    updateClock();

    // --- 초기화 ---
    function init() {
        loadPage(100);
        cmdInput.focus();
    }
    
    // --- 페이지 로더 ---
    function loadPage(pageNo) {
        if(inputBlocked) return;
        
        mainView.innerHTML = "";
        mainView.scrollTop = 0;
        cmdInput.value = "";
        currentPage = pageNo;
        promptText.innerText = `선택(번호) >`;

        // 페이지 분기
        if(pageNo === 100) renderMainMenu();
        else if(NEWS_CATS[pageNo]) fetchNewsList(pageNo);
        else if(pageNo === 30) renderWeatherRegionMenu(); // 30: 권역 선택 메뉴
        else if(pageNo === 31) fetchLocalWeather(); // 31: 내 위치 (김천 포함)
        else if(pageNo >= 32 && pageNo <= 37) fetchRegionalWeather(pageNo); // 권역별 상세
        else if(pageNo === 99) renderHelp();
        else renderError("존재하지 않는 페이지입니다.");
    }

    // --- 메인 메뉴 ---
    function renderMainMenu() {
        const art = `
<span class="c-c">┌──────────────────────────────────────────────────┐</span>
<span class="c-c">│</span>  <span class="c-y">N E W S   B B S</span>                 <span class="c-g">System Ready</span>    <span class="c-c">│</span>
<span class="c-c">│</span>                                                  <span class="c-c">│</span>
<span class="c-c">│</span>  <span class="c-w">[ 뉴시스 Newsis ]</span>                               <span class="c-c">│</span>
<span class="c-c">│</span>   11.속보 12.정치 13.경제 14.금융 15.산업        <span class="c-c">│</span>
<span class="c-c">│</span>   16.사회 17.국제 18.문화 19.스포츠              <span class="c-c">│</span>
<span class="c-c">│</span>                                                  <span class="c-c">│</span>
<span class="c-c">│</span>  <span class="c-w">[ 연합뉴스 Yonhap ]</span> (기사본문 지원)             <span class="c-c">│</span>
<span class="c-c">│</span>   21.전체 22.정치 23.경제 24.산업 25.사회        <span class="c-c">│</span>
<span class="c-c">│</span>   26.전국 27.국제 28.문화 29.스포츠              <span class="c-c">│</span>
<span class="c-c">│</span>                                                  <span class="c-c">│</span>
<span class="c-c">│</span>  <span class="c-w">[ 날씨 Weather (Open-Meteo) ]</span>                   <span class="c-c">│</span>
<span class="c-c">│</span>   30. <span class="c-y">전국/권역별 날씨</span> (시/군/구)                <span class="c-c">│</span>
<span class="c-c">│</span>   31. 내 위치 날씨 (GPS 정밀)                    <span class="c-c">│</span>
<span class="c-c">│</span>                                                  <span class="c-c">│</span>
<span class="c-c">│</span>   99. 도움말              X.  접속 종료          <span class="c-c">│</span>
<span class="c-c">└──────────────────────────────────────────────────┘</span>

<span class="c-w"> * 번호를 입력하거나 화면을 터치하세요.</span>
`;
        mainView.innerHTML = art;
    }

    // --- 뉴스 목록 ---
    async function fetchNewsList(catId) {
        renderLoading();
        const cat = NEWS_CATS[catId];
        let xmlText = null;

        for (const proxy of PROXIES) {
            try {
                const res = await fetch(proxy + encodeURIComponent(cat.u));
                if (res.ok) {
                    xmlText = await res.text();
                    break;
                }
            } catch (e) { console.warn("Proxy fail"); }
        }

        if (!xmlText) { renderError("데이터 수신 실패.\n잠시 후 다시 시도하세요."); return; }

        try {
            const parser = new DOMParser();
            const xml = parser.parseFromString(xmlText, "text/xml");
            const items = xml.querySelectorAll("item");
            
            window.currentNewsItems = [];
            items.forEach(node => {
                window.currentNewsItems.push({
                    title: node.querySelector("title")?.textContent || "",
                    desc: node.querySelector("description")?.textContent || "",
                    date: node.querySelector("pubDate")?.textContent || "",
                    link: node.querySelector("link")?.textContent || "",
                    isYonhap: (catId >= 20 && catId < 30)
                });
            });

            let output = `<span class="c-y">■ ${cat.t} ■</span>\n\n`;
            
            window.currentNewsItems.slice(0, 15).forEach((item, idx) => {
                let title = item.title;
                title = title.replace(/&quot;/g, '"').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
                if(title.length > 22) title = title.substring(0, 21) + "..";
                
                let timeStr = "";
                try {
                    const d = new Date(item.date);
                    const now = new Date();
                    if(d.toDateString() === now.toDateString()) {
                        timeStr = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
                    } else {
                        timeStr = (d.getMonth()+1) + "/" + d.getDate();
                    }
                } catch(e){}

                const num = (idx + 1).toString().padStart(2, '0');
                output += `<div class="t-link" onclick="showNewsDetail(${idx})"><span class="c-g">${num}</span> ${title} <span class="c-c" style="float:right">${timeStr}</span></div>`;
            });

            output += `\n<span class="c-w">[M:메뉴] [번호:읽기]</span>`;
            mainView.innerHTML = output;
            promptText.innerText = "선택(기사번호) >";
        } catch(e) {
            renderError("RSS 파싱 오류");
        }
    }

    // --- 뉴스 상세 ---
    window.showNewsDetail = async function(idx) {
        const item = window.currentNewsItems[idx];
        if(!item) return;

        let cleanDesc = item.desc.replace(/<[^>]*>/g, "").trim();
        
        let header = `
<span class="c-c">┌──────────────────────────────────────────────────┐</span>
<span class="c-y"> ${item.title}</span>
<span class="c-c">└──────────────────────────────────────────────────┘</span>
<span class="c-g">작성일: ${item.date}</span>
`;
        
        let loadingMsg = "";
        if(item.isYonhap) {
            loadingMsg = `\n<span class="c-c blink">>> 본문 전체를 불러오는 중입니다...</span>\n`;
        }

        let body = `\n${cleanDesc}\n`;
        let footer = `\n<span class="c-w">====================================================</span>
<span class="c-c">[Enter:목록] [M:메뉴]</span>`;

        mainView.innerHTML = header + loadingMsg + body + footer;
        currentPage = 'READING';
        promptText.innerText = "명령(Enter) >";

        if(item.isYonhap) {
            try {
                let fullText = "";
                let fetched = false;

                for (const proxy of PROXIES) {
                    try {
                        const res = await fetch(proxy + encodeURIComponent(item.link));
                        if(res.ok) {
                            const html = await res.text();
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, "text/html");
                            
                            const article = doc.querySelector('.story-news') || doc.querySelector('#articleWrap') || doc.querySelector('.article-story');
                            if(article) { fullText = article.innerText; fetched = true; }
                            
                            if(fetched) break;
                        }
                    } catch(e) {}
                }

                if(fetched && fullText.length > 50) {
                    fullText = fullText.replace(/\n\s*\n/g, '\n\n');
                    mainView.innerHTML = header + `\n<span class="c-y">[전문]</span>\n` + fullText + footer;
                } else {
                    mainView.innerHTML = header + `\n<span class="c-r">(본문 수신 불가 - 요약본 표시)</span>\n` + body + footer;
                }
            } catch(e) { }
        }
    }

    // --- Open-Meteo API 날씨 가져오기 ---
    async function getOpenMeteoData(lat, lon) {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("API Call Failed");
        const json = await res.json();
        return json.current_weather; 
    }

    // WMO 날씨 코드 변환
    function getWeatherDesc(code) {
        if (code === 0) return "맑음";
        if (code >= 1 && code <= 3) return "구름";
        if (code >= 45 && code <= 48) return "안개";
        if (code >= 51 && code <= 67) return "비";
        if (code >= 71 && code <= 77) return "눈";
        if (code >= 80 && code <= 82) return "소나기";
        if (code >= 95 && code <= 99) return "뇌우";
        return "정보없음";
    }

    // --- 30번: 권역 선택 메뉴 (시도별 요약) ---
    function renderWeatherRegionMenu() {
        const art = `
<span class="c-y">■ 전국 권역별 날씨 ■</span>

 [지역 선택]
 --------------------------------------
 <span class="t-link" onclick="loadPage(32)">32. 수도권 (서울/인천/경기)</span>
 <span class="t-link" onclick="loadPage(33)">33. 강원도 (영서/영동)</span>
 <span class="t-link" onclick="loadPage(34)">34. 충청권 (대전/세종/충남/충북)</span>
 <span class="t-link" onclick="loadPage(35)">35. 전라권 (광주/전남/전북)</span>
 <span class="t-link" onclick="loadPage(36)">36. 경상권 (부산/대구/울산/경남/경북)</span>
 <span class="t-link" onclick="loadPage(37)">37. 제주도</span>
 --------------------------------------
 * 원하는 권역 번호를 선택하면 
   해당 지역의 상세 시/군/구 날씨를 볼 수 있습니다.

<span class="c-w">[31:내위치] [M:메인]</span>
`;
        mainView.innerHTML = art;
        promptText.innerText = "선택(번호) >";
    }

    // --- 지역별 상세 날씨 (시/군/구 전체) ---
    async function fetchRegionalWeather(pageNo) {
        renderLoading();
        try {
            // 해당 권역(reg)에 해당하는 도시들만 필터링
            const targetCities = Object.entries(KOREA_CITIES).filter(([name, data]) => data.reg === pageNo);
            
            if(targetCities.length === 0) { renderError("지역 정보 오류"); return; }

            // 권역 이름 찾기 (하드코딩 대신 맵핑)
            const regionNames = {32:"수도권", 33:"강원도", 34:"충청권", 35:"전라권", 36:"경상권", 37:"제주도"};
            
            let output = `<span class="c-y">■ ${regionNames[pageNo]} 상세 날씨 ■</span>\n`;
            output += `<span class="c-g">Data: Open-Meteo</span>\n\n`;
            output += `<div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px;">`;
            
            // 병렬 요청
            const promises = targetCities.map(async ([name, coords]) => {
                try {
                    const data = await getOpenMeteoData(coords.la, coords.lo);
                    return { 
                        name: name, 
                        temp: data.temperature, 
                        desc: getWeatherDesc(data.weathercode) 
                    };
                } catch(e) {
                    return { name: name, temp: "Err", desc: "-" };
                }
            });

            const results = await Promise.all(promises);

            results.forEach(item => {
                output += `<div><span class="c-c">[${item.name}]</span> <span class="c-w">${item.desc}</span> <span class="c-r">${item.temp}℃</span></div>`;
            });
            
            output += `</div>`;
            output += `\n<span class="c-w">[30:권역목록] [M:메인]</span>`;
            
            mainView.innerHTML = output;
            promptText.innerText = "명령(M) >";
            currentPage = pageNo; // 새로고침 용
        } catch(e) {
            renderError("날씨 정보 수신 실패");
        }
    }

    // --- 31번: 내 위치 날씨 (정밀 GPS - 김천 등 전국 매칭) ---
    function fetchLocalWeather() {
        if(!navigator.geolocation) {
            renderError("브라우저가 위치 정보를 지원하지 않습니다.");
            return;
        }
        
        mainView.innerHTML = `<span class="c-c blink">위성 신호 수신중... (GPS)</span>`;
        
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            
            try {
                // 1. 날씨 데이터
                const weather = await getOpenMeteoData(lat, lon);
                
                // 2. 가장 가까운 관측소/지역명 찾기 (KOREA_CITIES 전체 대상)
                let nearestName = "현위치";
                let minDist = Infinity;
                
                for(const [name, coords] of Object.entries(KOREA_CITIES)) {
                    const dist = Math.pow(coords.la - lat, 2) + Math.pow(coords.lo - lon, 2);
                    if(dist < minDist) {
                        minDist = dist;
                        nearestName = name;
                    }
                }

                // 3. Nominatim으로 상세 주소까지 시도 (실패 시 위 nearestName 사용)
                let addressDisplay = `${nearestName} 인근`;
                try {
                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=14`;
                    const res = await fetch(url);
                    if(res.ok) {
                        const json = await res.json();
                        const addr = json.address;
                        // 시 + 구/군/시 + 동 조합
                        const city = addr.city || addr.province || "";
                        const sub = addr.county || addr.district || addr.borough || "";
                        const town = addr.town || addr.village || "";
                        
                        if(city || sub) {
                            addressDisplay = `${city} ${sub} ${town}`.trim();
                        }
                    }
                } catch(e) {}

                let output = `
<span class="c-y">■ 내 위치 날씨 정보 ■</span>

<span class="c-w">현재 위치</span> : <span class="c-c">${addressDisplay}</span>
<span class="c-g">(GPS: ${lat.toFixed(2)}, ${lon.toFixed(2)})</span>

<span class="c-c">┌──────────────────────────┐</span>
   기  온 : <span class="c-r" style="font-size:1.5em">${weather.temperature}℃</span>
   상  태 : <span class="c-w" style="font-size:1.2em">${getWeatherDesc(weather.weathercode)}</span>
<span class="c-c">└──────────────────────────┘</span>
   풍  속 : ${weather.windspeed} km/h

<span class="c-g">Data by Open-Meteo</span>
<span class="c-w">[R:새로고침] [30:권역목록] [M:메인]</span>
`;
                mainView.innerHTML = output;
                promptText.innerText = "명령(M) >";
                currentPage = 31;
                
            } catch(e) {
                renderError("날씨 데이터 처리 실패");
            }
        }, (err) => {
            renderError("GPS 위치 권한을 승인해주세요.");
        });
    }

    // --- 유틸리티 ---
    function renderLoading() {
        mainView.innerHTML = `<span class="c-c blink">데이터를 불러오는 중입니다...</span>`;
    }

    function renderError(msg) {
        mainView.innerHTML = `<span class="c-r">!!! ERROR !!!</span>\n\n${msg}\n\n<span class="c-w">[M] 키를 눌러 메뉴로 복귀하세요.</span>`;
        currentPage = 'ERROR';
    }

    function renderHelp() {
        mainView.innerHTML = `
<span class="c-y">■ 도움말 ■</span>

1. 30번 메뉴에서 권역을 선택하면 시/군/구 상세 날씨를 볼 수 있습니다.
2. 31번은 GPS를 사용하여 현재 김천 등 사용자의 정확한 위치 날씨를 보여줍니다.
3. 기사 번호를 입력하면 내용을 볼 수 있습니다.

<span class="c-g">[M] 메인 메뉴로 돌아가기</span>
`;
    }

    // --- 입력 처리 ---
    cmdInput.addEventListener('keydown', function(e) {
        if(e.key === 'Enter') {
            const cmd = this.value.trim().toUpperCase();
            this.value = "";
            processCommand(cmd);
        }
    });

    // 화면 아무데나 누르면 입력창 포커스 (모바일 키보드 활성화)
    document.body.addEventListener('click', (e) => {
        // 링크 클릭이 아닐 때만 포커스
        if(!e.target.closest('.t-link')) {
            cmdInput.focus();
        }
    });

    function processCommand(cmd) {
        if(cmd === 'M' || cmd === 'MENU' || cmd === '100') {
            loadPage(100);
            return;
        }
        if(cmd === 'X' || cmd === 'Q') {
            alert("접속을 종료합니다.");
            window.close();
            return;
        }
        // 'R' 입력 시 새로고침
        if(cmd === 'R') {
            if(currentPage === 31) { fetchLocalWeather(); return; }
            if(currentPage >= 32 && currentPage <= 37) { fetchRegionalWeather(currentPage); return; }
        }

        if(currentPage === 'READING') {
            loadPage(100); 
            return;
        }
        
        // 숫자 입력 처리
        const num = parseInt(cmd);
        if(!isNaN(num)) {
            // 기사 목록 화면에서 1~45번 입력 시 상세보기
            if((currentPage >= 10 && currentPage <= 29) && (num >= 1 && num <= 45)) {
                showNewsDetail(num - 1);
            } else {
                // 그 외에는 페이지 이동
                loadPage(num);
            }
        }
    }

    // 시작
    init();

</script>
</body>
</html>
